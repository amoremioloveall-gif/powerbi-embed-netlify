<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Power BI Report Embed</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 16px; }
    #reportContainer { width: 100%; height: 80vh; border: 1px solid #ddd; }
    .badge { display:inline-block; padding:4px 8px; border-radius:6px; margin-left:8px; font-size:12px; }
    .view { background:#eef; }
    .edit { background:#fee; }
    #controls { margin: 12px 0; display:flex; gap:8px; flex-wrap:wrap; }
    #log { color:#b00; white-space:pre-wrap; font-size:12px; max-height:18vh; overflow:auto; background:#fafafa; border:1px dashed #ddd; padding:8px; }
    button { cursor:pointer; }
  </style>
</head>
<body>
  <h2>
    Survey Report Demo
    <span id="modeBadge" class="badge view">View</span>
  </h2>

  <div id="controls">
    <button id="btnSave">üíæ Save my view</button>
    <button id="btnReset">üîÑ Reset</button>
  </div>

  <div id="reportContainer"></div>
  <pre id="log"></pre>

  <!-- Power BI Client SDK -->
  <script src="https://cdn.jsdelivr.net/npm/powerbi-client/dist/powerbi.min.js"></script>
  <script>
    const models = window['powerbi-client']?.models;
    let report;               // embed instance
    let currentReportId = ''; // ƒë·ªÉ l√†m key l∆∞u

    /* ===== Utils ===== */
    function qs(name){ const u=new URL(location.href); return u.searchParams.get(name); }
    function keyFor(reportId){ return `pbi_viewstate_${reportId}`; }
    function log(x){ const el=document.getElementById('log'); el.textContent += (typeof x==='string'?x:JSON.stringify(x,null,2)) + "\n"; }

    /* ===== Capture current state (report filters + page filters + slicers) ===== */
    async function captureState(){
      const state = { version:1, reportId: currentReportId, reportFilters:[], pages:[] };

      // Report-level filters
      try { state.reportFilters = await report.getFilters(); }
      catch(e){ log(['‚ö†Ô∏è getFilters (report) error', String(e)]); }

      try{
        const pages = await report.getPages();
        for (const page of pages){
          const p = { name: page.name, displayName: page.displayName, filters: [], slicers: [] };

          // Page-level filters
          try { p.filters = await page.getFilters(); }
          catch(e){ log(['‚ö†Ô∏è getFilters (page)', page.name, String(e)]); }

          // Slicers state
          try {
            const visuals = await page.getVisuals();
            for (const v of visuals){
              const isSlicer = v.type && v.type.toLowerCase() === 'slicer';
              const canGet = typeof v.getSlicerState === 'function';
              if (isSlicer && canGet){
                try {
                  const st = await v.getSlicerState();
                  p.slicers.push({ name: v.name, state: st });
                } catch(e){ log(['‚ÑπÔ∏è skip slicer (get) error', v.name, String(e)]); }
              }
            }
          } catch(e){ log(['‚ö†Ô∏è getVisuals error', page.name, String(e)]); }

          state.pages.push(p);
        }
      } catch(e){ log(['‚ö†Ô∏è getPages error', String(e)]); }

      return state;
    }

    /* ===== Apply saved state safely ===== */
    async function applyState(saved){
      if (!saved) return;
      // 1) Report-level filters
      if (Array.isArray(saved.reportFilters)){
        try { await report.setFilters(saved.reportFilters); }
        catch(e){ log(['‚ö†Ô∏è setFilters (report) error', String(e)]); }
      }
      // 2) Page-level + slicers
      try{
        const pages = await report.getPages();
        for (const page of pages){
          const sp = saved.pages?.find(x => x.name === page.name || x.displayName === page.displayName);
          if (!sp) continue;

          if (Array.isArray(sp.filters)){
            try { await page.setFilters(sp.filters); } 
            catch(e){ log(['‚ö†Ô∏è setFilters (page)', page.name, String(e)]); }
          }

          if (Array.isArray(sp.slicers) && sp.slicers.length){
            try{
              const visuals = await page.getVisuals();
              for (const v of visuals){
                if (v.type && v.type.toLowerCase() === 'slicer' && typeof v.setSlicerState === 'function'){
                  const target = sp.slicers.find(s => s.name === v.name);
                  if (target){
                    try { await v.setSlicerState(target.state); }
                    catch(e){ log(['‚ÑπÔ∏è slicer apply error', v.name, String(e)]); }
                  }
                }
              }
            }catch(e){ log(['‚ö†Ô∏è getVisuals for apply error', page.name, String(e)]); }
          }
        }
      }catch(e){ log(['‚ö†Ô∏è apply pages error', String(e)]); }
    }

    /* ===== Hard Reset: clear report/page filters + clear slicers + remove saved ===== */
    async function hardReset(){
      try{
        // 1) Clear report-level filters
        try { await report.setFilters([]); } catch(e){ log(['‚ÑπÔ∏è report.setFilters([]) error', String(e)]); }

        // 2) Clear page-level + slicers
        try{
          const pages = await report.getPages();
          for (const page of pages){
            try { await page.setFilters([]); } catch(e){ log(['‚ÑπÔ∏è page.setFilters([])', page.name, String(e)]); }
            try{
              const visuals = await page.getVisuals();
              for (const v of visuals){
                if (v.type && v.type.toLowerCase() === 'slicer' && typeof v.setSlicerState === 'function'){
                  try { await v.setSlicerState({ filters: [] }); }
                  catch(e){ log(['‚ÑπÔ∏è slicer reset error', v.name, String(e)]); }
                }
              }
            }catch(e){ log(['‚ÑπÔ∏è getVisuals reset error', page.name, String(e)]); }
          }
        }catch(e){ log(['‚ÑπÔ∏è reset pages error', String(e)]); }

        // 3) Remove saved state
        localStorage.removeItem(keyFor(currentReportId || 'default'));

        alert('üîÑ View reset!');
      }catch(e){
        log(['‚ùå Hard reset error', String(e)]);
        alert('Reset failed. Check console/log.');
      }
    }

    /* ===== Main load ===== */
    async function loadReport(){
      try{
        if (!models){ log('‚ùå powerbi-client not loaded'); return; }

        const isAdmin = qs('admin') === '1';
        const mode = isAdmin ? 'edit' : 'view';

        // Build query for function
        const params = new URLSearchParams();
        params.set('mode', mode);
        ['reportId','datasetId','groupId'].forEach(k => { if (qs(k)) params.set(k, qs(k)); });

        // Fetch token & meta
        const res = await fetch('/.netlify/functions/embed-token?' + params.toString());
        let data; try { data = await res.json(); } catch(e){ log('‚ùå Cannot parse JSON from embed-token'); return; }
        if (!res.ok || data?.error){ log(['‚ùå embed-token error', data]); return; }

        currentReportId = data.reportId || '';

        // Badge
        const badge = document.getElementById('modeBadge');
        badge.textContent = data.mode || (isAdmin ? 'Edit' : 'View');
        badge.className = 'badge ' + (isAdmin ? 'edit' : 'view');

        // Embed config
        const config = {
          type: 'report',
          id: data.reportId,
          embedUrl: data.embedUrl,
          accessToken: data.token,
          tokenType: models.TokenType.Embed,
          viewMode: isAdmin ? models.ViewMode.Edit : models.ViewMode.View,
          settings: {
            panes: { filters: { visible: true }, pageNavigation: { visible: true } },
            navContentPaneEnabled: true
          }
        };

        const container = document.getElementById('reportContainer');
        if (!container){ log('‚ùå Missing #reportContainer'); return; }

        // Embed
        report = powerbi.embed(container, config);

        // Events
        report.on('loaded', async () => {
          log('‚úÖ Report loaded');

          // Apply saved state (if any)
          try{
            const raw = localStorage.getItem(keyFor(currentReportId));
            if (raw){
              const saved = JSON.parse(raw);
              await applyState(saved);
              log('üîÅ Applied saved view state');
            }
          }catch(e){ log(['‚ö†Ô∏è apply saved state error', String(e)]); }
        });

        report.on('rendered', () => log('üé® Report rendered'));
        report.on('error', e => log(['‚ùå Report error', e?.detail || e]));

        // Buttons
        document.getElementById('btnSave')?.addEventListener('click', async () => {
          try{
            const state = await captureState();
            localStorage.setItem(keyFor(currentReportId || 'default'), JSON.stringify(state));
            alert('‚úÖ View saved!');
          }catch(e){
            log(['‚ùå Save error', String(e)]);
            alert('Save failed. Check console/log.');
          }
        });

        document.getElementById('btnReset')?.addEventListener('click', hardReset);

      }catch(e){
        log(['‚ùå Outer error', String(e)]);
      }
    }

    loadReport();
  </script>
</body>
</html>
